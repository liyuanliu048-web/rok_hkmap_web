<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ROK MAP</title>
<style>
  :root { --bg:#0b1020; --card:#11182a; --muted:#94a3b8; --accent:#4f46e5; }
  html,body{height:100%;margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Noto Sans SC,sans-serif;}
  header{padding:14px 16px;border-bottom:1px solid #1f2937;background:#0b1020;position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:16px}
  main{display:grid;grid-template-columns:1fr 360px;gap:16px;padding:16px}
  .map-wrap{background:#0e152b;border-radius:14px;min-height:360px;display:flex;align-items:center;justify-content:center;border:1px solid #263047;overflow:hidden}
  .panel{background:var(--card);border-radius:14px;border:1px solid #263047;padding:16px;display:grid;gap:12px;height:fit-content}
  .panel h3{margin:0 0 6px 0;font-size:14px;color:#cbd5e1}
  .time{font-variant-numeric:tabular-nums;letter-spacing:1px;font-size:40px;text-align:center}
  .meta{color:var(--muted);font-size:12px;text-align:center}

  /* 紧凑输入：更小的框框 */
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .field label{display:block;margin:0 0 4px 2px;font-size:12px;color:var(--muted)}
  input[type="number"]{
    width:100%;padding:8px 10px;border-radius:10px;border:1px solid #334155;
    background:#0b1222;color:#e5e7eb;outline:none;font-size:14px;text-align:center
  }
  input[type="number"]:focus{border-color:var(--accent)}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#131a2e;color:#e5e7eb;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent}
  .loading{color:#9ca3af;font-size:14px}

  svg{width:100%;height:auto;display:block}
  .point{cursor:pointer}
  .point:hover{opacity:.9}

  /* 总控制盘：两列，无内部滚动条 */
  .dash{border-top:1px solid #263047;margin-top:8px;padding-top:12px}
  .dash h3{margin-top:4px}
  .list{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:8px}
  .item{
    display:grid;grid-template-columns:1fr auto;align-items:center;gap:6px;
    padding:10px 12px;border:1px solid #334155;border-radius:10px;background:#0b1222;cursor:pointer
  }
  .item .left{display:flex;align-items:center;gap:8px;min-width:0}
  .item .name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .item .time-mini{font-variant-numeric:tabular-nums;letter-spacing:1px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .dot{width:8px;height:8px;border-radius:50%;background:#64748b;flex:0 0 8px}
  .item.running .dot{background:#22c55e}
  .item.paused  .dot{background:#f59e0b}
  .item.idle    .dot{background:#64748b}
  .item.selected{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}

  @media (max-width:980px){ main{grid-template-columns:1fr;} }
  @media (max-width:520px){ .list{grid-template-columns:1fr;} } /* 小屏退回单列 */
</style>
</head>
<body>
  <header><h1>SVG 地图 · 倒计时（无徽标 · 双列总控）</h1></header>

  <main>
    <div class="map-wrap" id="mapContainer">
      <div class="loading">正在加载 map.svg …</div>
    </div>

    <aside class="panel">
      <!-- 上半：保持结构，框框更紧凑 -->
      <h3 id="title">未选择点位</h3>
      <div class="time" id="timeLeft">--:--:--</div>
      <div class="meta" id="statusMeta">状态：未开始</div>

      <div class="row">
        <div class="field"><label>小时</label><input type="number" id="hours" min="0" max="240" value="8"></div>
        <div class="field"><label>分钟</label><input type="number" id="mins"  min="0" max="59"  value="0"></div>
        <div class="field"><label>秒</label><input type="number" id="secs"  min="0" max="59"  value="0"></div>
      </div>

      <div class="row" style="grid-template-columns:repeat(3,1fr)">
        <button class="btn primary" id="startBtn">开始 / 继续</button>
        <button class="btn" id="pauseBtn">暂停</button>
        <button class="btn" id="resetBtn">重置</button>
      </div>

      <!-- 下半：总控制盘（两列） -->
      <div class="dash">
        <h3>总控制盘</h3>
        <div class="list" id="allList"></div>
      </div>
    </aside>
  </main>

<script>
(() => {
  const DEFAULT_MS = 8 * 3600 * 1000;

  // ===== 工具 =====
  const $ = s => document.querySelector(s);
  const fmtHMS = (ms) => {
    if (ms < 0) ms = 0;
    const t = Math.floor(ms / 1000);
    const h = Math.floor(t / 3600);
    const m = Math.floor((t % 3600) / 60);
    const s = t % 60;
    const pad2 = n => String(n).padStart(2,'0');
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  };
  const fmtHMLabel = (ms) => {
    if (ms < 0) ms = 0;
    const t = Math.floor(ms / 1000);
    const h = Math.floor(t / 3600);
    const m = Math.floor((t % 3600) / 60);
    const hh = h > 99 ? String(h) : String(h).padStart(2,'0');
    const mm = String(m).padStart(2,'0');
    return `${hh} ${mm}`;
  };

  // ===== 状态 =====
  const store = new Map(); // id -> { label, mode, durationMs, remainingMs, endAt, li:{root,time,name} }
  let currentId = null;
  let panelTicker = null;

  // ===== 右侧元素 =====
  const els = {
    container: $('#mapContainer'),
    list:      $('#allList'),
    title:     $('#title'),
    timeLeft:  $('#timeLeft'),
    status:    $('#statusMeta'),
    h:         $('#hours'),
    m:         $('#mins'),
    s:         $('#secs'),
    start:     $('#startBtn'),
    pause:     $('#pauseBtn'),
    reset:     $('#resetBtn'),
  };

  // ===== 本地持久化 =====
  const STORAGE_KEY = 'svg-map-timers-v2';

  function saveAll() {
    const plain = {};
    for (const [id, st] of store) {
      plain[id] = {
        label: st.label,
        mode: st.mode,
        durationMs: st.durationMs,
        remainingMs: st.remainingMs,
        endAt: st.endAt
      };
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ currentId, data: plain }));
  }

  function loadAll() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const { currentId: cid, data } = JSON.parse(raw);
      for (const id in data) {
        if (!store.has(id)) continue;
        Object.assign(store.get(id), data[id]);
      }
      if (cid && store.has(cid)) selectPoint(cid);
    } catch {}
  }

  // ===== 面板 =====
  const isEditingInputs = () => {
    const a = document.activeElement;
    return a === els.h || a === els.m || a === els.s;
  };

  const updatePanel = (st) => {
    const nowLeft =
      st.mode === 'running' ? Math.max(st.endAt - Date.now(), 0) :
      st.mode === 'paused'  ? Math.max(st.remainingMs || 0, 0) :
                              st.durationMs;

    els.title.textContent = `${st.label} · 倒计时`;
    els.timeLeft.textContent = fmtHMS(nowLeft);
    els.status.textContent =
      st.mode === 'running' ? `状态：进行中（完成≈ ${new Date(st.endAt).toLocaleString('zh-CN',{hour12:false})}）` :
      st.mode === 'paused'  ? '状态：已暂停' :
                              '状态：未开始';

    const hh = Math.floor(nowLeft / 3600000);
    const mm = Math.floor((nowLeft % 3600000) / 60000);
    const ss = Math.floor((nowLeft % 60000) / 1000);

    // 修复1：正在编辑时不回填，避免“跳回 8 小时”
    if (!isEditingInputs()) {
      els.h.value = hh; els.m.value = mm; els.s.value = ss;
    }
  };

  const selectPoint = (id) => {
    if (!store.has(id)) return;
    if (currentId && store.get(currentId)?.li) store.get(currentId).li.root.classList.remove('selected');
    currentId = id;
    const st = store.get(id);
    st.li?.root.classList.add('selected');
    updatePanel(st);
    saveAll();
  };

  // ===== 列表（总控制盘）=====
  const makeListItem = (id, label) => {
    const root = document.createElement('div');
    root.className = 'item idle';
    root.setAttribute('data-id', id);

    const left = document.createElement('div');
    left.className = 'left';
    const dot = document.createElement('span');
    dot.className = 'dot';
    const name = document.createElement('span');
    name.className = 'name';
    name.textContent = label;
    left.appendChild(dot); left.appendChild(name);

    const time = document.createElement('div');
    time.className = 'time-mini';
    time.textContent = '00 00';

    root.appendChild(left);
    root.appendChild(time);

    root.addEventListener('click', () => selectPoint(id));

    els.list.appendChild(root);
    return { root, time, name };
  };

  const updateListItem = (id) => {
    const st = store.get(id);
    if (!st?.li) return;

    let ms = 0;
    if (st.mode === 'running') ms = Math.max(0, st.endAt - Date.now());
    else if (st.mode === 'paused') ms = Math.max(0, st.remainingMs || 0);
    else ms = st.durationMs; // idle 显示默认时长

    st.li.time.textContent = fmtHMLabel(ms);

    st.li.root.classList.toggle('running', st.mode === 'running');
    st.li.root.classList.toggle('paused',  st.mode === 'paused');
    st.li.root.classList.toggle('idle',    st.mode === 'idle');
  };

  const startPanelTicker = () => {
    if (panelTicker) return;
    panelTicker = setInterval(() => {
      for (const [id] of store) updateListItem(id);
      if (currentId) updatePanel(store.get(currentId));
    }, 1000);
  };

  // ===== 输入框交互（修复2）=====
  const inputMs = () => {
    const hh = Math.max(0, Number(els.h.value) || 0);
    const mm = Math.max(0, Math.min(59, Number(els.m.value) || 0));
    const ss = Math.max(0, Math.min(59, Number(els.s.value) || 0));
    return (hh * 3600 + mm * 60 + ss) * 1000;
  };

  [els.h, els.m, els.s].forEach(inp => {
    // 实时预览上方大时间（未开始/暂停）
    inp.addEventListener('input', () => {
      if (!currentId) return;
      const st = store.get(currentId);
      if (st.mode !== 'running') {
        els.timeLeft.textContent = fmtHMS(inputMs());
      }
    });

    // 结束编辑：把输入写入默认时长（未开始/暂停）
    inp.addEventListener('change', () => {
      if (!currentId) return;
      const st = store.get(currentId);
      if (st.mode === 'running') return;
      const ms = inputMs();
      st.durationMs = ms;
      st.remainingMs = ms;
      updatePanel(st);
      updateListItem(currentId);
      saveAll();
    });

    // 回车快速开始
    inp.addEventListener('keydown', e => { if (e.key === 'Enter') els.start.click(); });
  });

  // ===== 右侧按钮 =====
  els.start.addEventListener('click', () => {
    if (!currentId) return;
    const st = store.get(currentId);
    const ms = inputMs();
    if (ms > 0) {
      st.durationMs = ms;
      st.mode = 'running';
      st.endAt = Date.now() + ms;
      st.remainingMs = null;
    } else if (st.mode === 'paused') {
      const left = Math.max(0, st.remainingMs || 0);
      st.mode = 'running';
      st.endAt = Date.now() + left;
      st.remainingMs = null;
    } else {
      st.mode = 'running';
      st.endAt = Date.now() + st.durationMs;
    }
    updatePanel(st);
    updateListItem(currentId);
    saveAll();
    startPanelTicker();
  });

  els.pause.addEventListener('click', () => {
    if (!currentId) return;
    const st = store.get(currentId);
    if (st.mode === 'running') {
      st.remainingMs = Math.max(0, st.endAt - Date.now());
      st.mode = 'paused';
      st.endAt = null;
      updatePanel(st);
      updateListItem(currentId);
      saveAll();
    }
  });

  // 重置：停止并还原为 8 小时（输入框也回到 8:00:00）
  els.reset.addEventListener('click', () => {
    if (!currentId) return;
    const st = store.get(currentId);
    st.mode = 'idle';
    st.durationMs = DEFAULT_MS;
    st.remainingMs = DEFAULT_MS;
    st.endAt = null;

    // 直接设置输入框，确保立即可见
    els.h.value = 8; els.m.value = 0; els.s.value = 0;

    updatePanel(st);
    updateListItem(currentId);
    saveAll();
  });

  // ===== 加载 SVG & 绑定点位（无徽标）=====
  const loadMap = async () => {
    try {
      const res = await fetch('map.svg', { cache: 'no-store' });
      if (!res.ok) throw new Error('加载失败');
      const svgText = await res.text();
      els.container.innerHTML = svgText;

      const points = els.container.querySelectorAll('.point');
      if (!points.length) {
        els.container.innerHTML = '<div class="loading">已加载 SVG，但未找到 .point 点位</div>';
        return;
      }

      let autoId = 0;
      points.forEach(g => {
        if (!g.getAttribute('data-id')) g.setAttribute('data-id', `p-${++autoId}`);
        const id    = g.getAttribute('data-id');
        const label = g.getAttribute('data-label') || id;

        store.set(id, { label, mode:'idle', durationMs:DEFAULT_MS, remainingMs:DEFAULT_MS, endAt:null, li:null });

        // 点击地图点位也可选择
        g.addEventListener('click', () => selectPoint(id));

        // 为总控创建一行
        const li = makeListItem(id, label);
        store.get(id).li = li;
        updateListItem(id);
      });

      // 恢复本地状态再刷新一次
      loadAll();
      for (const [id] of store) updateListItem(id);

      // 默认选中第一个
      if (!currentId) selectPoint(points[0].getAttribute('data-id'));

      startPanelTicker();
    } catch (e) {
      els.container.innerHTML = `<div class="loading">加载 map.svg 失败：${e.message}</div>`;
    }
  };

  loadMap();
})();
</script>
</body>
</html>
