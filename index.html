<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SVG 地图 · 极简倒计时</title>
<style>
  :root { --bg:#0b1020; --card:#11182a; --muted:#94a3b8; --accent:#4f46e5; }
  html,body{height:100%;margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Noto Sans SC,sans-serif;}
  header{padding:14px 16px;border-bottom:1px solid #1f2937;background:#0b1020;position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:16px}
  main{display:grid;grid-template-columns:1fr 340px;gap:16px;padding:16px}
  .map-wrap{background:#0e152b;border-radius:14px;min-height:360px;display:flex;align-items:center;justify-content:center;border:1px solid #263047;overflow:hidden}
  .panel{background:var(--card);border-radius:14px;border:1px solid #263047;padding:16px;display:grid;gap:12px;height:fit-content}
  .panel h3{margin:0 0 6px 0;font-size:14px;color:#cbd5e1}
  .time{font-variant-numeric:tabular-nums;letter-spacing:1px;font-size:40px;text-align:center}
  .meta{color:var(--muted);font-size:12px;text-align:center}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}
  input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1222;color:#e5e7eb;outline:none}
  input[type="number"]:focus{border-color:var(--accent)}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#131a2e;color:#e5e7eb;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent}
  .loading{color:#9ca3af;font-size:14px}
  svg{width:100%;height:auto;display:block}
  /* 仅保留最简单的可点态 */
  .point{cursor:pointer}
  .point:hover{opacity:.9}
  @media (max-width:900px){ main{grid-template-columns:1fr;}}
</style>
</head>
<body>
  <header><h1>SVG 地图 · 极简倒计时</h1></header>

  <main>
    <!-- 左侧：地图 -->
    <div class="map-wrap" id="mapContainer">
      <div class="loading">正在加载 map.svg …</div>
    </div>

    <!-- 右侧：倒计时面板 -->
    <aside class="panel">
      <h3 id="title">未选择点位</h3>
      <div class="time" id="timeLeft">--:--:--</div>
      <div class="meta" id="statusMeta">状态：未开始</div>

      <div class="row">
        <div><label>小时</label><input type="number" id="hours" min="0" max="240" value="8"></div>
        <div><label>分钟</label><input type="number" id="mins"  min="0" max="59"  value="0"></div>
        <div><label>秒</label><input type="number" id="secs"  min="0" max="59"  value="0"></div>
      </div>

      <div class="row">
        <button class="btn primary" id="startBtn">开始 / 继续</button>
        <button class="btn" id="pauseBtn">暂停</button>
        <button class="btn" id="resetBtn">重置</button>
      </div>
    </aside>
  </main>

<script>
(() => {
  // ===== 小工具 =====
  const $ = s => document.querySelector(s);
  const fmt = (ms) => {
    if (ms < 0) ms = 0;
    const t = Math.floor(ms / 1000);
    const h = Math.floor(t / 3600);
    const m = Math.floor((t % 3600) / 60);
    const s = t % 60;
    const pad = n => String(n).padStart(2,'0');
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  };

  // ===== 极简状态（会话内，不落地存储） =====
  const store = new Map(); // id -> { label, mode, durationMs, remainingMs, endAt }
  let currentId = null;
  let tickTimer = null;

  const els = {
    container: $('#mapContainer'),
    title:      $('#title'),
    timeLeft:   $('#timeLeft'),
    status:     $('#statusMeta'),
    h:          $('#hours'),
    m:          $('#mins'),
    s:          $('#secs'),
    start:      $('#startBtn'),
    pause:      $('#pauseBtn'),
    reset:      $('#resetBtn'),
  };

  const getState = (id, label) => {
    if (!store.has(id)) {
      const durationMs = 8 * 3600 * 1000;
      store.set(id, { label: label || id, mode: 'idle', durationMs, remainingMs: durationMs, endAt: null });
    }
    return store.get(id);
  };

  // ===== UI 同步 =====
  const updatePanel = (st) => {
    const nowLeft =
      st.mode === 'running' ? Math.max(st.endAt - Date.now(), 0) :
      st.mode === 'paused'  ? st.remainingMs :
                              st.durationMs;

    els.title.textContent = `${st.label} · 倒计时`;
    els.timeLeft.textContent = fmt(nowLeft);
    els.status.textContent =
      st.mode === 'running' ? `状态：进行中（完成≈ ${new Date(st.endAt).toLocaleString()}）` :
      st.mode === 'paused'  ? '状态：已暂停' :
                              '状态：未开始';

    const hh = Math.floor(nowLeft / 3600000);
    const mm = Math.floor((nowLeft % 3600000) / 60000);
    const ss = Math.floor((nowLeft % 60000) / 1000);
    els.h.value = hh; els.m.value = mm; els.s.value = ss;
  };

  const selectPoint = (id, label) => {
    currentId = id;
    const st = getState(id, label);
    updatePanel(st);
    if (st.mode === 'running') startTicker(); else stopTicker();
  };

  // ===== 计时器（只更新当前选中点位的显示） =====
  const startTicker = () => {
    stopTicker();
    tickTimer = setInterval(() => {
      if (!currentId) return;
      const st = store.get(currentId);
      if (!st || st.mode !== 'running') { stopTicker(); return; }
      const left = st.endAt - Date.now();
      if (left <= 0) {
        st.mode = 'idle';
        st.remainingMs = st.durationMs;
        st.endAt = null;
        updatePanel(st);
        stopTicker();
      } else {
        els.timeLeft.textContent = fmt(left);
      }
    }, 250);
  };
  const stopTicker = () => { if (tickTimer) { clearInterval(tickTimer); tickTimer = null; } };

  // ===== 右侧操作 =====
  const inputMs = () => {
    const hh = Math.max(0, Number(els.h.value) || 0);
    const mm = Math.max(0, Math.min(59, Number(els.m.value) || 0));
    const ss = Math.max(0, Math.min(59, Number(els.s.value) || 0));
    return (hh * 3600 + mm * 60 + ss) * 1000;
  };

  els.start.addEventListener('click', () => {
    if (!currentId) return;
    const st = store.get(currentId);
    if (st.mode === 'paused') {
      st.mode = 'running';
      st.endAt = Date.now() + Math.max(0, st.remainingMs || 0);
    } else {
      const ms = inputMs();
      st.durationMs = ms > 0 ? ms : st.durationMs;
      st.mode = 'running';
      st.endAt = Date.now() + (ms > 0 ? ms : st.durationMs);
      st.remainingMs = null;
    }
    updatePanel(st);
    startTicker();
  });

  els.pause.addEventListener('click', () => {
    if (!currentId) return;
    const st = store.get(currentId);
    if (st.mode === 'running') {
      st.remainingMs = Math.max(0, st.endAt - Date.now());
      st.mode = 'paused';
      st.endAt = null;
      updatePanel(st);
      stopTicker();
    }
  });

  els.reset.addEventListener('click', () => {
    if (!currentId) return;
    const st = store.get(currentId);
    st.mode = 'idle';
    st.remainingMs = st.durationMs;
    st.endAt = null;
    updatePanel(st);
    stopTicker();
  });

  // ===== 加载 map.svg 并绑定 .point =====
  const loadMap = async () => {
    try {
      const res = await fetch('map.svg', { cache: 'no-store' });
      if (!res.ok) throw new Error('加载失败');
      const svgText = await res.text();
      els.container.innerHTML = svgText;

      const points = els.container.querySelectorAll('.point');
      let autoId = 0;
      points.forEach(g => {
        if (!g.getAttribute('data-id')) g.setAttribute('data-id', `p-${++autoId}`);
        const id = g.getAttribute('data-id');
        const label = g.getAttribute('data-label') || id;
        getState(id, label);
        g.addEventListener('click', () => selectPoint(id, label));
      });

      // 默认选中第一个点位（如果有）
      if (points[0]) {
        const id = points[0].getAttribute('data-id');
        const label = points[0].getAttribute('data-label') || id;
        selectPoint(id, label);
      } else {
        els.container.innerHTML = '<div class="loading">已加载 SVG，但未找到 .point 点位</div>';
      }
    } catch (e) {
      els.container.innerHTML = `<div class="loading">加载 map.svg 失败：${e.message}</div>`;
    }
  };

  loadMap();
})();
</script>
</body>
</html>
