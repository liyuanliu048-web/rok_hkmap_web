<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SVG 地图 · 极简倒计时（含点位徽标）</title>
<style>
  :root { --bg:#0b1020; --card:#11182a; --muted:#94a3b8; --accent:#4f46e5; }
  html,body{height:100%;margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Noto Sans SC,sans-serif;}
  header{padding:14px 16px;border-bottom:1px solid #1f2937;background:#0b1020;position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:16px}
  main{display:grid;grid-template-columns:1fr 340px;gap:16px;padding:16px}
  .map-wrap{background:#0e152b;border-radius:14px;min-height:360px;display:flex;align-items:center;justify-content:center;border:1px solid #263047;overflow:hidden}
  .panel{background:var(--card);border-radius:14px;border:1px solid #263047;padding:16px;display:grid;gap:12px;height:fit-content}
  .panel h3{margin:0 0 6px 0;font-size:14px;color:#cbd5e1}
  .time{font-variant-numeric:tabular-nums;letter-spacing:1px;font-size:40px;text-align:center}
  .meta{color:var(--muted);font-size:12px;text-align:center}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row > *{flex:1}
  input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1222;color:#e5e7eb;outline:none}
  input[type="number"]:focus{border-color:var(--accent)}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#131a2e;color:#e5e7eb;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent}
  .loading{color:#9ca3af;font-size:14px}
  svg{width:100%;height:auto;display:block}
  .point{cursor:pointer}
  .point:hover{opacity:.9}
  @media (max-width:900px){ main{grid-template-columns:1fr;}}
</style>
</head>
<body>
  <header><h1>SVG 地图 · 极简倒计时（含点位徽标）</h1></header>

  <main>
    <!-- 左侧：地图 -->
    <div class="map-wrap" id="mapContainer">
      <div class="loading">正在加载 map.svg …</div>
    </div>

    <!-- 右侧：倒计时面板 -->
    <aside class="panel">
      <h3 id="title">未选择点位</h3>
      <div class="time" id="timeLeft">--:--:--</div>
      <div class="meta" id="statusMeta">状态：未开始</div>

      <div class="row">
        <div><label>小时</label><input type="number" id="hours" min="0" max="240" value="8"></div>
        <div><label>分钟</label><input type="number" id="mins"  min="0" max="59"  value="0"></div>
        <div><label>秒</label><input type="number" id="secs"  min="0" max="59"  value="0"></div>
      </div>

      <div class="row">
        <button class="btn primary" id="startBtn">开始 / 继续</button>
        <button class="btn" id="pauseBtn">暂停</button>
        <button class="btn" id="resetBtn">重置</button>
      </div>
    </aside>
  </main>

<script>
(() => {
  // ===== 工具函数 =====
  const $ = s => document.querySelector(s);
  const fmtHMS = (ms) => {
    if (ms < 0) ms = 0;
    const t = Math.floor(ms / 1000);
    const h = Math.floor(t / 3600);
    const m = Math.floor((t % 3600) / 60);
    const s = t % 60;
    const pad2 = n => String(n).padStart(2,'0');
    return `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  };
  const fmtHM = (ms) => {
    if (ms < 0) ms = 0;
    const t = Math.floor(ms / 1000);
    const h = Math.floor(t / 3600);
    const m = Math.floor((t % 3600) / 60);
    const pad2 = n => String(n).padStart(2,'0');
    return `${h}:${pad2(m)}`; // 小徽标：小时不截断，分钟两位
  };

  // ===== 状态管理（内存） =====
  const store = new Map(); // id -> { label, mode, durationMs, remainingMs, endAt, badgeRefs }
  let currentId = null;

  // ===== 右侧元素 =====
  const els = {
    container: $('#mapContainer'),
    title:      $('#title'),
    timeLeft:   $('#timeLeft'),
    status:     $('#statusMeta'),
    h:          $('#hours'),
    m:          $('#mins'),
    s:          $('#secs'),
    start:      $('#startBtn'),
    pause:      $('#pauseBtn'),
    reset:      $('#resetBtn'),
  };

  const ensureState = (id, label) => {
    if (!store.has(id)) {
      const durationMs = 8 * 3600 * 1000;
      store.set(id, {
        label: label || id,
        mode: 'idle',
        durationMs,
        remainingMs: durationMs,
        endAt: null,
        badgeRefs: null, // {group, rect, text}
      });
    }
    return store.get(id);
  };

  // ===== 徽标：创建 + 自适应宽度 + 显隐 =====
  const ensureBadge = (gPoint, id) => {
    let g = gPoint.querySelector(':scope > g.badge');
    if (!g) {
      const svgNS = 'http://www.w3.org/2000/svg';
      g = document.createElementNS(svgNS, 'g');
      g.setAttribute('class', 'badge');
      g.setAttribute('transform', 'translate(0,12)'); // 在点位下方 12px

      const rect = document.createElementNS(svgNS, 'rect');
      rect.setAttribute('x', '-18'); rect.setAttribute('y', '0');
      rect.setAttribute('width', '36'); rect.setAttribute('height', '14');
      rect.setAttribute('rx', '3'); rect.setAttribute('ry', '3');
      rect.setAttribute('fill', '#ffffff');
      rect.setAttribute('stroke', '#000000');
      rect.setAttribute('stroke-width', '1');

      const text = document.createElementNS(svgNS, 'text');
      text.setAttribute('x', '0'); text.setAttribute('y', '10');
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('font-size', '9');
      text.setAttribute('font-family','ui-monospace, SFMono-Regular, Menlo, Consolas, monospace');
      text.setAttribute('fill', '#000000');
      text.textContent = '--:--';

      g.appendChild(rect); g.appendChild(text);
      gPoint.appendChild(g);
      // 默认隐藏（idle 不显示）
      g.style.display = 'none';

      const st = store.get(id);
      st.badgeRefs = { group: g, rect, text };
    } else {
      const st = store.get(id);
      if (!st.badgeRefs) {
        const rect = g.querySelector('rect');
        const text = g.querySelector('text');
        st.badgeRefs = { group: g, rect, text };
      }
    }
  };

  const updateBadge = (id) => {
    const st = store.get(id);
    if (!st || !st.badgeRefs) return;
    const { group, rect, text } = st.badgeRefs;

    let show = false, ms = 0;
    if (st.mode === 'running') { show = true; ms = Math.max(0, st.endAt - Date.now()); }
    else if (st.mode === 'paused') { show = true; ms = Math.max(0, st.remainingMs || 0); }

    if (!show) { group.style.display = 'none'; return; }

    const label = fmtHM(ms);
    text.textContent = label;

    // 动态测宽，更新矩形宽度与居中
    // 先强制显示测量，再还原显示状态
    const prevDisplay = group.style.display;
    group.style.display = '';
    const w = Math.ceil(text.getBBox().width) + 10; // 左右 5px 内边距
    rect.setAttribute('x', String(-w / 2));
    rect.setAttribute('width', String(w));
    group.style.display = ''; // 保持显示
  };

  const updateAllBadges = () => {
    for (const [id] of store) updateBadge(id);
  };

  // ===== 右侧面板同步 =====
  const updatePanel = (st) => {
    const nowLeft =
      st.mode === 'running' ? Math.max(st.endAt - Date.now(), 0) :
      st.mode === 'paused'  ? Math.max(st.remainingMs || 0, 0) :
                              st.durationMs;

    els.title.textContent = `${st.label} · 倒计时`;
    els.timeLeft.textContent = fmtHMS(nowLeft);
    els.status.textContent =
      st.mode === 'running' ? `状态：进行中（完成≈ ${new Date(st.endAt).toLocaleString()}）` :
      st.mode === 'paused'  ? '状态：已暂停' :
                              '状态：未开始';

    const hh = Math.floor(nowLeft / 3600000);
    const mm = Math.floor((nowLeft % 3600000) / 60000);
    const ss = Math.floor((nowLeft % 60000) / 1000);
    els.h.value = hh; els.m.value = mm; els.s.value = ss;
  };

  const selectPoint = (id) => {
    currentId = id;
    const st = store.get(id);
    updatePanel(st);
    updateBadge(id);
  };

  // ===== 计时主循环（全局轻量 ticker） =====
  let ticker = null;
  const startTicker = () => {
    if (ticker) return;
    ticker = setInterval(() => {
      const now = Date.now();
      let needPanelRefresh = false;

      for (const [id, st] of store) {
        if (st.mode !== 'running') continue;
        const left = st.endAt - now;
        if (left <= 0) {
          // 收尾：归位 idle，隐藏徽标
          st.mode = 'idle';
          st.remainingMs = st.durationMs;
          st.endAt = null;
          updateBadge(id);
          if (id === currentId) needPanelRefresh = true;
        } else {
          // 正常刷新徽标
          updateBadge(id);
          if (id === currentId) needPanelRefresh = true;
        }
      }

      if (needPanelRefresh && currentId) updatePanel(store.get(currentId));
    }, 500);
  };
  const stopTickerIfIdle = () => {
    // 如果没有任何 running，就停表（节能）
    for (const [, st] of store) { if (st.mode === 'running') return; }
    if (ticker) { clearInterval(ticker); ticker = null; }
  };

  // ===== 右侧操作 =====
  const inputMs = () => {
    const hh = Math.max(0, Number(els.h.value) || 0);
    const mm = Math.max(0, Math.min(59, Number(els.m.value) || 0));
    const ss = Math.max(0, Math.min(59, Number(els.s.value) || 0));
    return (hh * 3600 + mm * 60 + ss) * 1000;
  };

  els.start.addEventListener('click', () => {
    if (!currentId) return;
    const st = store.get(currentId);
    const ms = inputMs();

    if (ms > 0) {
      // 显式设定一个新的时长并启动
      st.durationMs = ms;
      st.mode = 'running';
      st.endAt = Date.now() + ms;
      st.remainingMs = null;
    } else if (st.mode === 'paused') {
      // 继续
      const left = Math.max(0, st.remainingMs || 0);
      st.mode = 'running';
      st.endAt = Date.now() + left;
      st.remainingMs = null;
    } else {
      // idle 且未输入新时长 → 用默认 durationMs 启动
      st.mode = 'running';
      st.endAt = Date.now() + st.durationMs;
    }

    updatePanel(st);
    updateBadge(currentId);
    startTicker();
  });

  els.pause.addEventListener('click', () => {
    if (!currentId) return;
    const st = store.get(currentId);
    if (st.mode === 'running') {
      st.remainingMs = Math.max(0, st.endAt - Date.now());
      st.mode = 'paused';
      st.endAt = null;
      updatePanel(st);
      updateBadge(currentId);
      stopTickerIfIdle();
    }
  });

  els.reset.addEventListener('click', () => {
    if (!currentId) return;
    const st = store.get(currentId);
    st.mode = 'idle';
    st.remainingMs = st.durationMs;
    st.endAt = null;
    updatePanel(st);
    updateBadge(currentId); // 会隐藏
    stopTickerIfIdle();
  });

  // ===== 加载 map.svg 并绑定点位 =====
  const loadMap = async () => {
    try {
      const res = await fetch('map.svg', { cache: 'no-store' });
      if (!res.ok) throw new Error('加载失败');
      const svgText = await res.text();
      els.container.innerHTML = svgText;

      const points = els.container.querySelectorAll('.point');
      if (!points.length) {
        els.container.innerHTML = '<div class="loading">已加载 SVG，但未找到 .point 点位</div>';
        return;
      }

      let autoId = 0;
      points.forEach(g => {
        if (!g.getAttribute('data-id')) g.setAttribute('data-id', `p-${++autoId}`);
        const id = g.getAttribute('data-id');
        const label = g.getAttribute('data-label') || id;

        ensureState(id, label);
        ensureBadge(g, id);

        g.addEventListener('click', () => selectPoint(id));
      });

      // 默认选中第一个点位
      const first = points[0];
      selectPoint(first.getAttribute('data-id'));

      // 初次刷新徽标（大多数是 hidden，但做一次统一测量/布局）
      updateAllBadges();
    } catch (e) {
      els.container.innerHTML = `<div class="loading">加载 map.svg 失败：${e.message}</div>`;
    }
  };

  loadMap();
})();
</script>
</body>
</html>
